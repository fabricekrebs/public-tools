{"status":{},"contains_secrets":true,"product_version":"3.5.2","spec":{"description":"","resources":{"endpoints_information":[],"endpoint_definition_list":[],"credential_definition_list":[{"username":"admin","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":true,"secret_reference":{}},"value":"EKuB6efSgf+CmCu1LNSzq2pJK58aWgQ9D1+g5GYl9P1hUU4PYib4N\/nNgQ==:utf-8"},"name":"PC_ACCESS","cred_class":"static"}],"runbook":{"task_definition_list":[{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[{"kind":"app_task","name":"Define the Overlay Subnet Configuration"},{"kind":"app_task","name":"Create the variable files"},{"kind":"app_task","name":"Apply Terraform script"},{"kind":"app_task","name":"Create Calm Project"}],"name":"9fcd6fa0_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Define the Overlay Subnet Configuration"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create the variable files"}},{"from_task_reference":{"kind":"app_task","name":"Create the variable files"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Apply Terraform script"}},{"from_task_reference":{"kind":"app_task","name":"Apply Terraform script"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create Calm Project"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Define the Overlay Subnet Configuration","attrs":{"exit_status":[],"script":"#get the network values\nsubnets = \"\"\"@@{INTERNAL_SUBNET}@@\"\"\"\n\n#define the string\ninternal_subnet_json_string = \"[\"\ninternal_subnet_list_string = \"[\"\n\n#loop trough each network line\nfor line in subnets.splitlines():\n    line_array = line.split(\":\")\n    internal_subnet_json_string = internal_subnet_json_string + \"{ \\\n        name        = \\\"\"+ str(line_array[0]) +\"\\\", \\\n        description = \\\"Description of my unit test OVERLAY\\\", \\\n        subnet_type = \\\"OVERLAY\\\", \\\n        subnet_ip          = \\\"\" + str(line_array[1]) +\"\\\", \\\n        default_gateway_ip = \\\"\" + str(line_array[3]) +\"\\\", \\\n        ip_config_pool_list_ranges = [\\\"\" + str(line_array[4]) +\"\\\"], \\\n        prefix_length = \\\"\" + str(line_array[2]) +\"\\\" \\\n    },\"\n   \n    internal_subnet_list_string = internal_subnet_list_string + \"\\\"\" + (str(line_array[0])) + \"\\\",\"\n\n#close the last list\ninternal_subnet_json_string = internal_subnet_json_string + \"]\"\n\n#remove the last comma\ninternal_subnet_list_string = internal_subnet_list_string[:-1]\n#close the list\ninternal_subnet_list_string = internal_subnet_list_string + \"]\"\n\n#output the value to manage it in calm\nprint(\"INTERNAL_SUBNET_JSON=\" + internal_subnet_json_string)\nprint(\"INTERNAL_SUBNET_LIST=\" + internal_subnet_list_string)","eval_variables":["INTERNAL_SUBNET_JSON","INTERNAL_SUBNET_LIST"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Create the variable files","attrs":{"script":"#go under the terraform dir\ncd @@{SCRIPT_DIR}@@\/terraform\n\n#create the variable file\ncat >variables\/@@{VPC_NAME}@@.terraform.tfvars <<'EOF'\nnutanix_cluster_name        = \"@@{NUTANIX_CLUSTER}@@\"\npc_address                  = \"@@{PC_ADDRESS}@@\"\npc_user                     = \"@@{PC_ACCESS.username}@@\"\npc_password                 = \"@@{PC_ACCESS.secret}@@\"\npc_port                     = 9440\nexternal_network             = \"@@{EXTERNAL_NETWORK}@@\"\n\nvpc_name                     = \"@@{VPC_NAME}@@\"\nEOF\n\n\n#append the overlay to terraform variable file\ntee -a variables\/@@{VPC_NAME}@@.terraform.tfvars << EOF\ninternal_subnet\t\t\t\t= @@{INTERNAL_SUBNET_JSON}@@\nEOF\n\n\n#go under the terraform dir\ncd @@{SCRIPT_DIR}@@\/calm\n\n#create the variable file\ncat > .local\/variables <<'EOF'\n{\n    \"LINUX_KEY_PATH\":\"\/home\/nutanix\/.ssh\/id_rsa\",\n    \"LINUX_PUBLIC_KEY_PATH\":\"\/home\/nutanix\/.ssh\/id_rsa.pub\",\n    \"CENTOS_KEY_PATH\" : \"keys\/centos\",\n    \"CENTOS_PUBLIC_KEY_PATH\" : \"keys\/centos.pub\",\n    \"ACCOUNT\" : \"@@{ACCOUNT}@@\",\n    \"INTERNAL_SUBNET\" : @@{INTERNAL_SUBNET_LIST}@@,\n    \"EXTERNAL_NETWORK\" : \"@@{EXTERNAL_NETWORK}@@\",\n    \"CLUSTER\" : \"@@{NUTANIX_CLUSTER}@@\",\n    \"USER\" : \"@@{CUSTOMER}@@-user01@ntnxlab.local\",\n    \"GROUP\" : \"cn=sspadmins,cn=users,dc=ntnx,dc=local\",\n    \"VCPUS\" : 1,\n    \"STORAGE\" : 2,\n    \"MEMORY\" : 1,\n    \"CLOUD_INIT_PATH\" : \"cloud-init-data.yaml\",\n    \"VPC\": \"@@{VPC_NAME}@@\"\n}\nEOF\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Apply Terraform script","attrs":{"script":"#go under the terraform dir\ncd @@{SCRIPT_DIR}@@\/terraform\n\n#initialize the terraform directory\nterraform init\n\n#create the terraform workspace with VPC_NAME\nterraform workspace new @@{VPC_NAME}@@\n\n#apply the terraform script\nterraform apply -var-file variables\/@@{VPC_NAME}@@.terraform.tfvars -auto-approve\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","inherit_target":false,"child_tasks_local_reference_list":[],"name":"Create Calm Project","attrs":{"script":"#prepare the virtual environment\ncd @@{SCRIPT_DIR}@@\/calm\/calm-dsl\n. venv\/bin\/activate\ncd ..\n\n#create the user\ncalm create user --name @@{CUSTOMER}@@-user01@ntnxlab.local --directory @@{DIRECTORY_SERVICE}@@\n\n#update the calm cache\ncalm update cache\n\n#create the new project\ncalm create project -n @@{VPC_NAME}@@ -f project_definition.py\n\n#create the acp for the new user\ncalm create acp --role @@{CUSTOMER_ROLE}@@ --project @@{VPC_NAME}@@ --user @@{CUSTOMER}@@-user01@ntnxlab.local\n\n#create the tunnel on the first network\ncalm create network-group-tunnel -n @@{VPC_NAME}@@ -f project_definition.py","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"b38587e9_runbook","main_task_local_reference":{"kind":"app_task","name":"9fcd6fa0_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"CUSTOMER","value":"customer02","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"ACCOUNT","value":"Nutanix_Demo_Cluster","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"SCRIPT_DIR","value":"~\/cloud-native-automation\/calm\/msp","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"VPC_NAME","value":"vpc-02","label":"","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"regex":{"should_validate":false,"value":"^(.|\\n)*$"},"val_type":"MULTILINE_STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"INTERNAL_SUBNET","value":"Subnet01:10.10.20.0:25:10.10.20.1:10.10.20.50 10.10.20.99:ntnxlab.local\nSubnet02:10.10.30.0:25:10.10.30.1:10.10.30.50 10.10.30.99:ntnxlab.local","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"EXTERNAL_NETWORK","value":"External","label":"","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"regex":{"should_validate":false,"value":"(([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\\\\.){3}([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])"},"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"DNS","value":"8.8.8.8","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"CUSTOMER_ROLE","value":"Customer-User","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"NUTANIX_CLUSTER","value":"DM3-POC085","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"PC_ADDRESS","value":"10.55.85.39","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"DIRECTORY_SERVICE","value":"AD2022","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]},"client_attrs":{},"default_target_reference":{"kind":"app_endpoint","name":"bastion"}},"name":"VPC Creation"},"api_version":"3.0","metadata":{"last_update_time":"1667480094185080","kind":"runbook","spec_version":16,"creation_time":"1667372107010501","name":"VPC Creation"}}